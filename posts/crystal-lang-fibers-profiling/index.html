
<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://alexkutsan.github.io/js/theme.min.js" integrity="sha384-pb++s6uBRKaQv+iAXpgA/H3IlpLZdO14tTwuCI7uXmz4aaZdByoCcM+6BhynMq/1"></script>
  <link rel="stylesheet" href="https://alexkutsan.github.io/abridge.css?h=17d1d14ae374495df55a" />
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="base" content="https://alexkutsan.github.io" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="referrer" content="strict-origin-when-cross-origin" />
  <meta name="theme-color" content="#333333" />
  <meta name="msapplication-TileColor" content="#333333" />
  <link rel="mask-icon" href="https://alexkutsan.github.io/safari-pinned-tab.svg" color="#ff9900" />
  <link rel="icon" type="image/svg+xml" href="https://alexkutsan.github.io/favicon.svg" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://alexkutsan.github.io/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="https://alexkutsan.github.io/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="https://alexkutsan.github.io/favicon-16x16.png" />
  <link rel="alternate" type="application/atom+xml" title="Alexander Kutsan Atom Feed" href="https://alexkutsan.github.io/atom.xml" />
  <meta name="robots" content="index, follow" />
  <meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <title>Crystal Lang Fibers Profiling | Alexander Kutsan</title>
  <meta name="author" content="Alexandet Kutsan" />
  <meta name="copyright" content="Alexander Kutsan" />
  <meta name="description" content="Find what fiber consumes the most CPU time" />
  <link rel="canonical" href="https://alexkutsan.github.io/posts/crystal-lang-fibers-profiling/" />
  <meta name="keywords" content="Programm, security, appsec, crystal lang" />
  <script defer src="https://alexkutsan.github.io/js/abridge_nopwa.min.js?h=da86cb0a199b3ccbdff1" integrity="sha384-vIpObQoso10COS540XqkYFIjE+P0OwczzYDnC2D28QZ8O6slixwCc+F1xxYZKvFr"></script>
  <noscript><link rel="stylesheet" href="https://alexkutsan.github.io/nojs.css" /></noscript>
</head>
<body>
  <header>
    <nav>
      <div><big><a href="/" title="Alexander Kutsan"><font color="#f90">A</font>lex <font color="#f90">K</font>utsan</a></big></div>
      <div>

        <div>
          <ul><li><a class="s110" href="https://alexkutsan.github.io/posts/"> Posts </a></li><li><a class="s110" href="https://alexkutsan.github.io/categories/"> Categories </a></li><li><a class="s110" href="https://alexkutsan.github.io/tags/"> Tags </a></li><li><i type="reset" id="mode" class="js svgs adjust"></i></ul>
        </div>

        <div>
          <div>
            <form autocomplete=off class="js" name="goSearch" id="searchbox">
              <div class="searchd">
                <input id="searchinput" type="text" placeholder="Search" title="Search" />
                <button type="submit" title="Search" class="svgs svgm search"></button>
              </div>
              <div class="results"><div id="suggestions"></div></div>
            </form>
          </div>
        </div>

      </div>
    </nav>
    <div class="desc">Software engineer, cybersecurity enthusiast</div>
  </header>
  <main>
    <article>
      <h1><a href="https://alexkutsan.github.io/posts/crystal-lang-fibers-profiling/">Crystal Lang Fibers Profiling</a></h1>

      <span class="s95"> Alexandet Kutsan <span class="rpad"></span> June 01, 2025 <span class="rpad"></span> [<a href="https://alexkutsan.github.io/categories/technical/">Technical</a>] #<a href="https://alexkutsan.github.io/tags/crystal/">crystal</a>  #<a href="https://alexkutsan.github.io/tags/concurrency/">concurrency</a>  #<a href="https://alexkutsan.github.io/tags/profiling/">profiling</a> </span>

    


<p>Crystal's fiber-based concurrency model enables elegant single-threaded development, but performance bottlenecks can be difficult to debug—especially when a misbehaving fiber monopolizes CPU time and freezes the entire application.</p>
<p>Crystal’s runtime tracing can help identify which fibers consume the most resources. However, the traditional approach requires enabling tracing at startup, which is impractical for long-running services since it generates gigabytes of logs.</p>
<p>Fortunately, Crystal’s monkey-patching capabilities allow us to dynamically enable scheduler tracing using Unix signals, offering a lightweight and practical way to diagnose fiber-related performance issues in production applications.</p>
<span id="continue-reading"></span><h1 id="liryc-intro">Liryc intro</h1>
<p>Crystal is a relatively young language. It isn’t backed by a tech giant like Go is with Google. It's not a low-level systems language, and developers aren’t typically optimizing for microseconds. Crystal mostly competes in the same space as Go, Node.js, Python, and even Java—for server-side applications.</p>
<p>Of course, you can build desktop apps, CLI tools, and daemons with Crystal. But when you start using it, it’s clear it was built with HTTP services in mind.</p>
<h2 id="concurrency-in-crystal">Concurrency in Crystal</h2>
<p>Crystal is still under active development and doesn’t yet offer official multithreading support. Instead, it provides Fibers—a concept similar to Go's goroutines.</p>
<p>There’s a preview of multithreading support, but it’s experimental and should be used with caution.</p>
<p>For small HTTP services or apps that do many I/O-bound operations, multithreading is often unnecessary. The lack of it doesn’t significantly impact performance—unless you're building high-load services with strict response time requirements.</p>
<p>Crystal’s concurrency model is straightforward — and that’s something I really like about it. Everything happens in a single thread. When you create a fiber using the spawn keyword, it doesn’t start executing immediately. It waits until the scheduler gives it a turn.</p>
<p>Context switching happens during I/O operations, sleeps, channels interactions, or when Fiber.yield is explicitly called.</p>
<p>Because of this, you can write your code as if it's single-threaded, which greatly reduces cognitive overhead. You can be confident your data won’t be modified mid-instruction by another fiber.</p>
<p>If you do enable multithreading, things get complex fast. That said, recent improvements have introduced the concept of <a rel="noopener" target="_blank" href="https://crystal-lang.org/api/1.16.3/Fiber/ExecutionContext.html">execution contexts</a>, allowing you to spawn fibers within a shared thread context. I haven’t explored this deeply yet, but I’m very excited about it.</p>
<h2 id="the-problem-identifying-misbehaving-fibers">The Problem: Identifying Misbehaving Fibers</h2>
<p>So, finally to the problem. When you are working in one thread, many fibers are competing for CPU time on it.
Even a single fiber that is doing heavy calculations, or stuck in an infinite or just a very long loop can freeze the whole application, because other fibers will suffer from lack of execution time.</p>
<p>Because Fibers are not OS-level abstractions - there is no easy way to find a fiber to blame.</p>
<p>One more pretty recent feature in Crystal is Runtime tracing. It allows having additional prints for different events related to the garbage collector or scheduler.
That is, analyzing scheduler events can give insight into what fiber takes most of the CPU time.
The "resume" and "reschedule" events fit well for this.</p>
<p>But in the design of how tracing is proposed to be used - there is a significant obstacle.
You can enable tracing by setting env variables. And tracing obviously impacts performance and produces tons of data for analysis.
For long-running applications like microservices, you probably don't want to keep tracing enabled for days and deal with hundreds of gigabytes (or even more) of tracing logs.
You could turn on ENV variables with gdb at runtime, but it doesn't work, because Crystal obviously is not reading them on every tracing event - reading happens once at the beginning of the program.
I would love to enable tracing on a running application at a specific point in time when I observe high CPU consumption, and then disable it. And Crystal allows me to do that.
One of Crystal's other cool features is the ability to monkey-patch stdlib.
You can redefine any function or class from Crystal internals in your application. Crystal source code is available and pretty easy to read and understand.</p>
<h2 id="dynamic-tracing-solution">Dynamic Tracing Solution</h2>
<p>With a short look at the tracing implementation https://github.com/crystal-lang/crystal/blob/master/src/crystal/tracing.cr, tracing is happening for events if Tracing.sections enum contains the proper flag.
And Tracing.sections can be changed at runtime.</p>
<pre data-lang="crystal" class="language-crystal z-code"><code class="language-crystal" data-lang="crystal"><span class="z-source z-crystal"><span class="z-meta z-module z-crystal"><span class="z-keyword z-control z-module z-crystal">module</span> <span class="z-entity z-name z-type z-module z-crystal"><span class="z-entity z-other z-inherited-class z-module z-first z-crystal">Crystal<span class="z-punctuation z-separator z-inheritance z-crystal">::</span></span>Tracing</span></span>
</span><span class="z-source z-crystal">    <span class="z-meta z-function z-method z-without-arguments z-crystal"><span class="z-keyword z-control z-def z-crystal">def</span> <span class="z-entity z-name z-function z-crystal">self.enable_scheduler_tracing</span></span>
</span><span class="z-source z-crystal">      <span class="z-variable z-other z-readwrite z-class z-crystal"><span class="z-punctuation z-definition z-variable z-crystal">@@</span>sections</span> <span class="z-keyword z-operator z-assignment z-crystal">=</span> <span class="z-support z-class z-crystal">Section</span><span class="z-punctuation z-separator z-other z-crystal">:</span><span class="z-punctuation z-separator z-other z-crystal">:</span><span class="z-support z-class z-crystal">Sched</span>
</span><span class="z-source z-crystal">      <span class="z-support z-class z-crystal">System</span><span class="z-punctuation z-separator z-method z-crystal">.</span>print_error <span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>[dynamic_tracing] Scheduler tracing ENABLED<span class="z-constant z-character z-escape z-crystal">\n</span><span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span>
</span><span class="z-source z-crystal">    <span class="z-keyword z-control z-secondary z-end z-crystal">end</span>
</span><span class="z-source z-crystal">
</span><span class="z-source z-crystal">    <span class="z-meta z-function z-method z-without-arguments z-crystal"><span class="z-keyword z-control z-def z-crystal">def</span> <span class="z-entity z-name z-function z-crystal">self.disable_scheduler_tracing</span></span>
</span><span class="z-source z-crystal">      <span class="z-variable z-other z-readwrite z-class z-crystal"><span class="z-punctuation z-definition z-variable z-crystal">@@</span>sections</span> <span class="z-keyword z-operator z-assignment z-crystal">=</span> <span class="z-support z-class z-crystal">Section</span><span class="z-punctuation z-separator z-other z-crystal">:</span><span class="z-punctuation z-separator z-other z-crystal">:</span><span class="z-support z-class z-crystal">None</span>
</span><span class="z-source z-crystal">      <span class="z-support z-class z-crystal">System</span><span class="z-punctuation z-separator z-method z-crystal">.</span>print_error <span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>[dynamic_tracing] Scheduler tracing DISABLED<span class="z-constant z-character z-escape z-crystal">\n</span><span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span>
</span><span class="z-source z-crystal">    <span class="z-keyword z-control z-secondary z-end z-crystal">end</span>
</span><span class="z-source z-crystal"><span class="z-keyword z-control z-secondary z-end z-crystal">end</span>
</span></code></pre>
<p>So the only thing you need to do is turn on tracing based on some IPC user input, and turn it off with another.
The simplest and most robust way - turn on scheduler tracing with SIGUSR1, and turn it off with SIGUSR2.
And this is a couple of lines of code:</p>
<pre data-lang="crystal" class="language-crystal z-code"><code class="language-crystal" data-lang="crystal"><span class="z-source z-crystal"><span class="z-support z-class z-crystal">Signal</span><span class="z-punctuation z-separator z-other z-crystal">:</span><span class="z-punctuation z-separator z-other z-crystal">:</span><span class="z-support z-class z-crystal">USR1</span><span class="z-punctuation z-separator z-method z-crystal">.</span>trap <span class="z-punctuation z-section z-scope z-crystal">{</span><span class="z-meta z-syntax z-crystal z-start-block"> </span><span class="z-support z-class z-crystal">Crystal</span><span class="z-punctuation z-separator z-other z-crystal">:</span><span class="z-punctuation z-separator z-other z-crystal">:</span><span class="z-support z-class z-crystal">Tracing</span><span class="z-punctuation z-separator z-method z-crystal">.</span>enable_scheduler_tracing <span class="z-punctuation z-section z-scope z-crystal">}</span>
</span><span class="z-source z-crystal"><span class="z-support z-class z-crystal">Signal</span><span class="z-punctuation z-separator z-other z-crystal">:</span><span class="z-punctuation z-separator z-other z-crystal">:</span><span class="z-support z-class z-crystal">USR2</span><span class="z-punctuation z-separator z-method z-crystal">.</span>trap <span class="z-punctuation z-section z-scope z-crystal">{</span><span class="z-meta z-syntax z-crystal z-start-block"> </span><span class="z-support z-class z-crystal">Crystal</span><span class="z-punctuation z-separator z-other z-crystal">:</span><span class="z-punctuation z-separator z-other z-crystal">:</span><span class="z-support z-class z-crystal">Tracing</span><span class="z-punctuation z-separator z-method z-crystal">.</span>disable_scheduler_tracing <span class="z-punctuation z-section z-scope z-crystal">}</span>
</span></code></pre>
<h2 id="using-dynamic-tracing-in-practice">Using Dynamic Tracing in Practice</h2>
<p>Now you can use it.
I'll give an example of an application like:</p>
<pre data-lang="crystal" class="language-crystal z-code"><code class="language-crystal" data-lang="crystal"><span class="z-source z-crystal"><span class="z-comment z-line z-number-sign z-crystal"><span class="z-punctuation z-definition z-comment z-crystal">#</span> try_runtime_tracing.cr
</span></span><span class="z-source z-crystal"><span class="z-meta z-require z-crystal"><span class="z-keyword z-control z-special-method z-crystal">require</span> <span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>socket<span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span></span>
</span><span class="z-source z-crystal">
</span><span class="z-source z-crystal"><span class="z-meta z-module z-crystal"><span class="z-keyword z-control z-module z-crystal">module</span> <span class="z-entity z-name z-type z-module z-crystal"><span class="z-entity z-other z-inherited-class z-module z-first z-crystal">Crystal<span class="z-punctuation z-separator z-inheritance z-crystal">::</span></span>Tracing</span></span>
</span><span class="z-source z-crystal">    <span class="z-meta z-function z-method z-without-arguments z-crystal"><span class="z-keyword z-control z-def z-crystal">def</span> <span class="z-entity z-name z-function z-crystal">self.enable_scheduler_tracing</span></span>
</span><span class="z-source z-crystal">      <span class="z-variable z-other z-readwrite z-class z-crystal"><span class="z-punctuation z-definition z-variable z-crystal">@@</span>sections</span> <span class="z-keyword z-operator z-assignment z-crystal">=</span> <span class="z-support z-class z-crystal">Section</span><span class="z-punctuation z-separator z-other z-crystal">:</span><span class="z-punctuation z-separator z-other z-crystal">:</span><span class="z-support z-class z-crystal">Sched</span>
</span><span class="z-source z-crystal">      <span class="z-support z-class z-crystal">System</span><span class="z-punctuation z-separator z-method z-crystal">.</span>print_error <span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>[dynamic_tracing] Scheduler tracing ENABLED<span class="z-constant z-character z-escape z-crystal">\n</span><span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span>
</span><span class="z-source z-crystal">    <span class="z-keyword z-control z-secondary z-end z-crystal">end</span>
</span><span class="z-source z-crystal">    <span class="z-meta z-function z-method z-without-arguments z-crystal"><span class="z-keyword z-control z-def z-crystal">def</span> <span class="z-entity z-name z-function z-crystal">self.disable_scheduler_tracing</span></span>
</span><span class="z-source z-crystal">      <span class="z-variable z-other z-readwrite z-class z-crystal"><span class="z-punctuation z-definition z-variable z-crystal">@@</span>sections</span> <span class="z-keyword z-operator z-assignment z-crystal">=</span> <span class="z-support z-class z-crystal">Section</span><span class="z-punctuation z-separator z-other z-crystal">:</span><span class="z-punctuation z-separator z-other z-crystal">:</span><span class="z-support z-class z-crystal">None</span>
</span><span class="z-source z-crystal">      <span class="z-support z-class z-crystal">System</span><span class="z-punctuation z-separator z-method z-crystal">.</span>print_error <span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>[dynamic_tracing] Scheduler tracing DISABLED<span class="z-constant z-character z-escape z-crystal">\n</span><span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span>
</span><span class="z-source z-crystal">    <span class="z-keyword z-control z-secondary z-end z-crystal">end</span>
</span><span class="z-source z-crystal"><span class="z-keyword z-control z-secondary z-end z-crystal">end</span>
</span><span class="z-source z-crystal"><span class="z-support z-class z-crystal">Signal</span><span class="z-punctuation z-separator z-other z-crystal">:</span><span class="z-punctuation z-separator z-other z-crystal">:</span><span class="z-support z-class z-crystal">USR1</span><span class="z-punctuation z-separator z-method z-crystal">.</span>trap <span class="z-punctuation z-section z-scope z-crystal">{</span><span class="z-meta z-syntax z-crystal z-start-block"> </span><span class="z-support z-class z-crystal">Crystal</span><span class="z-punctuation z-separator z-other z-crystal">:</span><span class="z-punctuation z-separator z-other z-crystal">:</span><span class="z-support z-class z-crystal">Tracing</span><span class="z-punctuation z-separator z-method z-crystal">.</span>enable_scheduler_tracing <span class="z-punctuation z-section z-scope z-crystal">}</span>
</span><span class="z-source z-crystal"><span class="z-support z-class z-crystal">Signal</span><span class="z-punctuation z-separator z-other z-crystal">:</span><span class="z-punctuation z-separator z-other z-crystal">:</span><span class="z-support z-class z-crystal">USR2</span><span class="z-punctuation z-separator z-method z-crystal">.</span>trap <span class="z-punctuation z-section z-scope z-crystal">{</span><span class="z-meta z-syntax z-crystal z-start-block"> </span><span class="z-support z-class z-crystal">Crystal</span><span class="z-punctuation z-separator z-other z-crystal">:</span><span class="z-punctuation z-separator z-other z-crystal">:</span><span class="z-support z-class z-crystal">Tracing</span><span class="z-punctuation z-separator z-method z-crystal">.</span>disable_scheduler_tracing <span class="z-punctuation z-section z-scope z-crystal">}</span>
</span><span class="z-source z-crystal">
</span><span class="z-source z-crystal"><span class="z-keyword z-control z-special-method z-crystal">spawn</span><span class="z-punctuation z-section z-function z-crystal">(</span><span class="z-constant z-other z-symbol z-crystal z-19syntax">name<span class="z-punctuation z-definition z-constant z-crystal">:</span></span> <span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>Fiber_cpu_blocker1<span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span><span class="z-punctuation z-section z-function z-crystal">)</span> <span class="z-punctuation z-section z-scope z-crystal">{</span><span class="z-meta z-syntax z-crystal z-start-block"> </span><span class="z-keyword z-control z-special-method z-crystal">loop</span> <span class="z-punctuation z-section z-scope z-crystal">{</span><span class="z-meta z-syntax z-crystal z-start-block"> </span><span class="z-constant z-numeric z-crystal">100_000</span><span class="z-punctuation z-separator z-method z-crystal">.</span>times <span class="z-punctuation z-section z-scope z-crystal">{</span><span class="z-meta z-syntax z-crystal z-start-block">  </span><span class="z-punctuation z-section z-scope z-crystal">}</span><span class="z-punctuation z-separator z-statement z-crystal">;</span> <span class="z-support z-class z-crystal">Fiber</span><span class="z-punctuation z-separator z-method z-crystal">.</span>yield<span class="z-punctuation z-section z-scope z-crystal">}</span> <span class="z-punctuation z-section z-scope z-crystal">}</span>
</span><span class="z-source z-crystal"><span class="z-keyword z-control z-special-method z-crystal">spawn</span><span class="z-punctuation z-section z-function z-crystal">(</span><span class="z-constant z-other z-symbol z-crystal z-19syntax">name<span class="z-punctuation z-definition z-constant z-crystal">:</span></span> <span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>Fiber_cpu_blocker2<span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span><span class="z-punctuation z-section z-function z-crystal">)</span> <span class="z-punctuation z-section z-scope z-crystal">{</span><span class="z-meta z-syntax z-crystal z-start-block"> </span><span class="z-keyword z-control z-special-method z-crystal">loop</span> <span class="z-punctuation z-section z-scope z-crystal">{</span><span class="z-meta z-syntax z-crystal z-start-block"> </span><span class="z-constant z-numeric z-crystal">200_000</span><span class="z-punctuation z-separator z-method z-crystal">.</span>times <span class="z-punctuation z-section z-scope z-crystal">{</span><span class="z-meta z-syntax z-crystal z-start-block">  </span><span class="z-punctuation z-section z-scope z-crystal">}</span><span class="z-punctuation z-separator z-statement z-crystal">;</span> <span class="z-support z-class z-crystal">Fiber</span><span class="z-punctuation z-separator z-method z-crystal">.</span>yield<span class="z-punctuation z-section z-scope z-crystal">}</span> <span class="z-punctuation z-section z-scope z-crystal">}</span>
</span><span class="z-source z-crystal"><span class="z-keyword z-control z-special-method z-crystal">spawn</span><span class="z-punctuation z-section z-function z-crystal">(</span><span class="z-constant z-other z-symbol z-crystal z-19syntax">name<span class="z-punctuation z-definition z-constant z-crystal">:</span></span> <span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>Fiber_IO<span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span><span class="z-punctuation z-section z-function z-crystal">)</span> <span class="z-keyword z-control z-start-block z-crystal">do
</span></span><span class="z-source z-crystal">  <span class="z-keyword z-control z-special-method z-crystal">loop</span> <span class="z-keyword z-control z-start-block z-crystal">do
</span></span><span class="z-source z-crystal">      socket <span class="z-keyword z-operator z-assignment z-crystal">=</span> <span class="z-support z-class z-crystal">TCPSocket</span><span class="z-punctuation z-separator z-method z-crystal">.</span><span class="z-keyword z-control z-special-method z-crystal">new</span><span class="z-punctuation z-section z-function z-crystal">(</span><span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>example.com<span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span><span class="z-punctuation z-separator z-object z-crystal">,</span> <span class="z-constant z-numeric z-crystal">80</span><span class="z-punctuation z-section z-function z-crystal">)</span>
</span><span class="z-source z-crystal">      socket<span class="z-punctuation z-separator z-method z-crystal">.</span>puts <span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>GET / HTTP/1.1<span class="z-constant z-character z-escape z-crystal">\r</span><span class="z-constant z-character z-escape z-crystal">\n</span>Host: example.com<span class="z-constant z-character z-escape z-crystal">\r</span><span class="z-constant z-character z-escape z-crystal">\n</span>Connection: close<span class="z-constant z-character z-escape z-crystal">\r</span><span class="z-constant z-character z-escape z-crystal">\n</span><span class="z-constant z-character z-escape z-crystal">\r</span><span class="z-constant z-character z-escape z-crystal">\n</span><span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span>
</span><span class="z-source z-crystal">      socket<span class="z-punctuation z-separator z-method z-crystal">.</span>gets_to_end
</span><span class="z-source z-crystal">    <span class="z-keyword z-control z-primary z-crystal">rescue</span>
</span><span class="z-source z-crystal">    <span class="z-keyword z-control z-primary z-crystal">ensure</span>
</span><span class="z-source z-crystal">      socket<span class="z-punctuation z-separator z-method z-crystal">.</span>try <span class="z-keyword z-operator z-arithmetic z-crystal">&amp;</span><span class="z-punctuation z-separator z-method z-crystal">.</span>close
</span><span class="z-source z-crystal">  <span class="z-keyword z-control z-secondary z-end z-crystal">end</span>
</span><span class="z-source z-crystal"><span class="z-keyword z-control z-secondary z-end z-crystal">end</span>
</span><span class="z-source z-crystal"><span class="z-keyword z-control z-special-method z-crystal">spawn</span><span class="z-punctuation z-section z-function z-crystal">(</span><span class="z-constant z-other z-symbol z-crystal z-19syntax">name<span class="z-punctuation z-definition z-constant z-crystal">:</span></span> <span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>Fiber_sleeper<span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span><span class="z-punctuation z-section z-function z-crystal">)</span> <span class="z-punctuation z-section z-scope z-crystal">{</span><span class="z-meta z-syntax z-crystal z-start-block"> </span><span class="z-keyword z-control z-special-method z-crystal">loop</span> <span class="z-punctuation z-section z-scope z-crystal">{</span><span class="z-meta z-syntax z-crystal z-start-block"> </span>sleep <span class="z-constant z-numeric z-crystal">10</span><span class="z-punctuation z-separator z-method z-crystal">.</span>milliseconds<span class="z-punctuation z-separator z-statement z-crystal">;</span> <span class="z-punctuation z-section z-scope z-crystal">}</span> <span class="z-punctuation z-section z-scope z-crystal">}</span>
</span><span class="z-source z-crystal">sleep <span class="z-comment z-line z-number-sign z-crystal"><span class="z-punctuation z-definition z-comment z-crystal">#</span> forever
</span></span></code></pre>
<p>First of all, you should compile the application with the -Dtracing flag:</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">crystal</span></span><span class="z-meta z-function-call z-arguments z-shell"> build try_runtime_tracing.cr<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>Dtracing</span></span>
</span></code></pre>
<p>For convenience, let's run the application with env <code>CRYSTAL_TRACE_FILE=trace.log</code>, so that we don't mix tracing output with what we see in the terminal.</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-variable z-other z-readwrite z-assignment z-shell">CRYSTAL_TRACE_FILE</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">trace.log</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">./try_runtime_tracing</span></span>
</span></code></pre>
<p>For now, the application is running without any tracing, so you will not see any tracing output and performance is not affected significantly.</p>
<p>Now let's try to turn on tracing:</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-kill z-shell">kill</span></span><span class="z-meta z-function-call z-arguments z-shell"> -USR1 <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">pgrep</span></span><span class="z-meta z-function-call z-arguments z-shell"> try_runtime</span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span> </span>
</span></code></pre>
<p>And trace.log rapidly grows with tracing output.
After some time, for example 1 minute, you can turn tracing off to keep the application working without additional performance impact:</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-kill z-shell">kill</span></span><span class="z-meta z-function-call z-arguments z-shell"> -USR2 <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">pgrep</span></span><span class="z-meta z-function-call z-arguments z-shell"> try_runtime</span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span></span>
</span></code></pre>
<h2 id="analyzing-trace-results">Analyzing Trace Results</h2>
<p>And analyze the results of the tracing.
In tracing logs, when a fiber gets CPU time - it is a "resume" event.
When a fiber is switched because of sleep or IO operation - it is a "reschedule" event.
Usually I love to write such scripts in Python. But today is Crystal time, so let's do it:</p>
<pre data-lang="crystal" class="language-crystal z-code"><code class="language-crystal" data-lang="crystal"><span class="z-source z-crystal"><span class="z-comment z-line z-number-sign z-crystal"><span class="z-punctuation z-definition z-comment z-crystal">#</span> fiber_cpu_time_distribution.cr
</span></span><span class="z-source z-crystal">trace_file <span class="z-keyword z-operator z-assignment z-crystal">=</span> <span class="z-support z-class z-crystal">ARGV</span><span class="z-punctuation z-section z-array z-crystal">[</span><span class="z-constant z-numeric z-crystal">0</span><span class="z-punctuation z-section z-array z-crystal">]</span>? <span class="z-keyword z-operator z-logical z-crystal">||</span> abort<span class="z-punctuation z-section z-function z-crystal">(</span><span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>Usage: <span class="z-source z-crystal z-embedded z-source"><span class="z-punctuation z-section z-embedded z-crystal">#{</span><span class="z-support z-class z-crystal">PROGRAM_NAME</span><span class="z-punctuation z-section z-embedded z-crystal">}</span></span> &lt;logfile&gt;<span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span><span class="z-punctuation z-section z-function z-crystal">)</span>
</span><span class="z-source z-crystal">abort<span class="z-punctuation z-section z-function z-crystal">(</span><span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>File not found: <span class="z-source z-crystal z-embedded z-source"><span class="z-punctuation z-section z-embedded z-crystal">#{</span>trace_file<span class="z-punctuation z-section z-embedded z-crystal">}</span></span><span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span><span class="z-punctuation z-section z-function z-crystal">)</span> <span class="z-keyword z-control z-primary z-crystal">unless</span> <span class="z-support z-class z-crystal">File</span><span class="z-punctuation z-separator z-method z-crystal">.</span>exists?<span class="z-punctuation z-section z-function z-crystal">(</span>trace_file<span class="z-punctuation z-section z-function z-crystal">)</span>
</span><span class="z-source z-crystal">
</span><span class="z-source z-crystal">resume_pattern <span class="z-keyword z-operator z-assignment z-crystal">=</span> <span class="z-string z-regexp z-classic z-crystal"><span class="z-punctuation z-definition z-string z-crystal">/</span></span><span class="z-string z-regexp z-classic z-crystal">sched<span class="z-constant z-character z-escape z-crystal">\.</span>resume <span class="z-string z-regexp z-group z-crystal"><span class="z-punctuation z-definition z-group z-crystal">(</span>?&lt;timestamp&gt;<span class="z-constant z-character z-escape z-crystal">\d</span>+<span class="z-punctuation z-definition z-group z-crystal">)</span></span> .*fiber=<span class="z-string z-regexp z-group z-crystal"><span class="z-punctuation z-definition z-group z-crystal">(</span>?&lt;prev_id&gt;0x<span class="z-string z-regexp z-character-class z-crystal"><span class="z-punctuation z-definition z-character-class z-crystal">[</span><span class="z-constant z-character z-escape z-crystal">\d</span>a-f<span class="z-punctuation z-definition z-character-class z-crystal">]</span></span>+<span class="z-punctuation z-definition z-group z-crystal">)</span></span>:<span class="z-string z-regexp z-group z-crystal"><span class="z-punctuation z-definition z-group z-crystal">(</span>?&lt;prev_name&gt;<span class="z-constant z-character z-escape z-crystal">\S</span>+<span class="z-punctuation z-definition z-group z-crystal">)</span></span> fiber=<span class="z-string z-regexp z-group z-crystal"><span class="z-punctuation z-definition z-group z-crystal">(</span>?&lt;next_id&gt;0x<span class="z-string z-regexp z-character-class z-crystal"><span class="z-punctuation z-definition z-character-class z-crystal">[</span><span class="z-constant z-character z-escape z-crystal">\d</span>a-f<span class="z-punctuation z-definition z-character-class z-crystal">]</span></span>+<span class="z-punctuation z-definition z-group z-crystal">)</span></span>:<span class="z-string z-regexp z-group z-crystal"><span class="z-punctuation z-definition z-group z-crystal">(</span>?&lt;next_name&gt;<span class="z-constant z-character z-escape z-crystal">\S</span>+<span class="z-punctuation z-definition z-group z-crystal">)</span></span></span><span class="z-string z-regexp z-classic z-crystal"><span class="z-punctuation z-definition z-string z-crystal">/</span></span>
</span><span class="z-source z-crystal">reschedule_pattern <span class="z-keyword z-operator z-assignment z-crystal">=</span> <span class="z-string z-regexp z-classic z-crystal"><span class="z-punctuation z-definition z-string z-crystal">/</span></span><span class="z-string z-regexp z-classic z-crystal">sched<span class="z-constant z-character z-escape z-crystal">\.</span>reschedule <span class="z-string z-regexp z-group z-crystal"><span class="z-punctuation z-definition z-group z-crystal">(</span>?&lt;timestamp&gt;<span class="z-constant z-character z-escape z-crystal">\d</span>+<span class="z-punctuation z-definition z-group z-crystal">)</span></span> .*fiber=<span class="z-string z-regexp z-group z-crystal"><span class="z-punctuation z-definition z-group z-crystal">(</span>?&lt;fiber_id&gt;0x<span class="z-string z-regexp z-character-class z-crystal"><span class="z-punctuation z-definition z-character-class z-crystal">[</span><span class="z-constant z-character z-escape z-crystal">\d</span>a-f<span class="z-punctuation z-definition z-character-class z-crystal">]</span></span>+<span class="z-punctuation z-definition z-group z-crystal">)</span></span>:<span class="z-string z-regexp z-group z-crystal"><span class="z-punctuation z-definition z-group z-crystal">(</span>?&lt;fiber_name&gt;<span class="z-constant z-character z-escape z-crystal">\S</span>+<span class="z-punctuation z-definition z-group z-crystal">)</span></span></span><span class="z-string z-regexp z-classic z-crystal"><span class="z-punctuation z-definition z-string z-crystal">/</span></span>
</span><span class="z-source z-crystal">
</span><span class="z-source z-crystal"><span class="z-comment z-line z-number-sign z-crystal"><span class="z-punctuation z-definition z-comment z-crystal">#</span> Store fiber data: {resume_time, total_active_time}
</span></span><span class="z-source z-crystal">fiber_data <span class="z-keyword z-operator z-assignment z-crystal">=</span> <span class="z-support z-class z-crystal">Hash</span><span class="z-punctuation z-section z-function z-crystal">(</span><span class="z-support z-class z-crystal">String</span><span class="z-punctuation z-separator z-object z-crystal">,</span> <span class="z-support z-class z-crystal">Tuple</span><span class="z-punctuation z-section z-function z-crystal">(</span><span class="z-support z-class z-crystal">Int64</span>?<span class="z-punctuation z-separator z-object z-crystal">,</span> <span class="z-support z-class z-crystal">Int64</span><span class="z-punctuation z-section z-function z-crystal">)</span><span class="z-punctuation z-section z-function z-crystal">)</span><span class="z-punctuation z-separator z-method z-crystal">.</span><span class="z-keyword z-control z-special-method z-crystal">new</span> <span class="z-punctuation z-section z-scope z-crystal">{</span><span class="z-meta z-syntax z-crystal z-start-block"> </span><span class="z-punctuation z-separator z-variable z-crystal">|</span><span class="z-variable z-other z-block z-crystal">hash</span><span class="z-punctuation z-separator z-variable z-crystal">,</span> <span class="z-variable z-other z-block z-crystal">key</span><span class="z-punctuation z-separator z-variable z-crystal">|</span> hash<span class="z-punctuation z-section z-array z-crystal">[</span>key<span class="z-punctuation z-section z-array z-crystal">]</span> <span class="z-keyword z-operator z-assignment z-crystal">=</span> <span class="z-punctuation z-section z-scope z-crystal">{</span><span class="z-constant z-language z-crystal">nil</span><span class="z-punctuation z-separator z-object z-crystal">,</span> <span class="z-constant z-numeric z-crystal">0_i64</span><span class="z-punctuation z-section z-scope z-crystal">}</span> <span class="z-punctuation z-section z-scope z-crystal">}</span>
</span><span class="z-source z-crystal">
</span><span class="z-source z-crystal"><span class="z-support z-class z-crystal">File</span><span class="z-punctuation z-separator z-method z-crystal">.</span>each_line<span class="z-punctuation z-section z-function z-crystal">(</span>trace_file<span class="z-punctuation z-section z-function z-crystal">)</span> <span class="z-keyword z-control z-start-block z-crystal">do </span><span class="z-punctuation z-separator z-variable z-crystal">|</span><span class="z-variable z-other z-block z-crystal">line</span><span class="z-punctuation z-separator z-variable z-crystal">|</span>
</span><span class="z-source z-crystal">  <span class="z-keyword z-control z-primary z-crystal">if</span> match <span class="z-keyword z-operator z-assignment z-crystal">=</span> line<span class="z-punctuation z-separator z-method z-crystal">.</span>match<span class="z-punctuation z-section z-function z-crystal">(</span>resume_pattern<span class="z-punctuation z-section z-function z-crystal">)</span>
</span><span class="z-source z-crystal">    timestamp <span class="z-keyword z-operator z-assignment z-crystal">=</span> match<span class="z-punctuation z-section z-array z-crystal">[</span><span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>timestamp<span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span><span class="z-punctuation z-section z-array z-crystal">]</span><span class="z-punctuation z-separator z-method z-crystal">.</span>to_i64
</span><span class="z-source z-crystal">    next_fiber <span class="z-keyword z-operator z-assignment z-crystal">=</span> match<span class="z-punctuation z-section z-array z-crystal">[</span><span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>next_name<span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span><span class="z-punctuation z-section z-array z-crystal">]</span> <span class="z-keyword z-operator z-comparison z-crystal">!=</span> <span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>?<span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span> <span class="z-keyword z-operator z-comparison z-crystal">?</span> match<span class="z-punctuation z-section z-array z-crystal">[</span><span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>next_name<span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span><span class="z-punctuation z-section z-array z-crystal">]</span> <span class="z-punctuation z-separator z-other z-crystal">:</span> match<span class="z-punctuation z-section z-array z-crystal">[</span><span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>next_id<span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span><span class="z-punctuation z-section z-array z-crystal">]</span>
</span><span class="z-source z-crystal">    fiber_data<span class="z-punctuation z-section z-array z-crystal">[</span>next_fiber<span class="z-punctuation z-section z-array z-crystal">]</span> <span class="z-keyword z-operator z-assignment z-crystal">=</span> <span class="z-punctuation z-section z-scope z-crystal">{</span>timestamp<span class="z-punctuation z-separator z-object z-crystal">,</span> fiber_data<span class="z-punctuation z-section z-array z-crystal">[</span>next_fiber<span class="z-punctuation z-section z-array z-crystal">]</span><span class="z-punctuation z-section z-array z-crystal">[</span><span class="z-constant z-numeric z-crystal">1</span><span class="z-punctuation z-section z-array z-crystal">]</span><span class="z-punctuation z-section z-scope z-crystal">}</span>
</span><span class="z-source z-crystal">  <span class="z-keyword z-control z-secondary z-crystal">elsif</span> match <span class="z-keyword z-operator z-assignment z-crystal">=</span> line<span class="z-punctuation z-separator z-method z-crystal">.</span>match<span class="z-punctuation z-section z-function z-crystal">(</span>reschedule_pattern<span class="z-punctuation z-section z-function z-crystal">)</span>
</span><span class="z-source z-crystal">    timestamp <span class="z-keyword z-operator z-assignment z-crystal">=</span> match<span class="z-punctuation z-section z-array z-crystal">[</span><span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>timestamp<span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span><span class="z-punctuation z-section z-array z-crystal">]</span><span class="z-punctuation z-separator z-method z-crystal">.</span>to_i64
</span><span class="z-source z-crystal">    fiber_name <span class="z-keyword z-operator z-assignment z-crystal">=</span> match<span class="z-punctuation z-section z-array z-crystal">[</span><span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>fiber_name<span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span><span class="z-punctuation z-section z-array z-crystal">]</span> <span class="z-keyword z-operator z-comparison z-crystal">!=</span> <span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>?<span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span> <span class="z-keyword z-operator z-comparison z-crystal">?</span> match<span class="z-punctuation z-section z-array z-crystal">[</span><span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>fiber_name<span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span><span class="z-punctuation z-section z-array z-crystal">]</span> <span class="z-punctuation z-separator z-other z-crystal">:</span> match<span class="z-punctuation z-section z-array z-crystal">[</span><span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>fiber_id<span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span><span class="z-punctuation z-section z-array z-crystal">]</span>
</span><span class="z-source z-crystal">    <span class="z-keyword z-control z-primary z-crystal">if</span> resume_time <span class="z-keyword z-operator z-assignment z-crystal">=</span> fiber_data<span class="z-punctuation z-section z-array z-crystal">[</span>fiber_name<span class="z-punctuation z-section z-array z-crystal">]</span><span class="z-punctuation z-section z-array z-crystal">[</span><span class="z-constant z-numeric z-crystal">0</span><span class="z-punctuation z-section z-array z-crystal">]</span>
</span><span class="z-source z-crystal">      active_time <span class="z-keyword z-operator z-assignment z-crystal">=</span> timestamp <span class="z-keyword z-operator z-arithmetic z-crystal">-</span> resume_time
</span><span class="z-source z-crystal">      current_active_time <span class="z-keyword z-operator z-assignment z-crystal">=</span> fiber_data<span class="z-punctuation z-section z-array z-crystal">[</span>fiber_name<span class="z-punctuation z-section z-array z-crystal">]</span><span class="z-punctuation z-section z-array z-crystal">[</span><span class="z-constant z-numeric z-crystal">1</span><span class="z-punctuation z-section z-array z-crystal">]</span>
</span><span class="z-source z-crystal">      fiber_data<span class="z-punctuation z-section z-array z-crystal">[</span>fiber_name<span class="z-punctuation z-section z-array z-crystal">]</span> <span class="z-keyword z-operator z-assignment z-crystal">=</span> <span class="z-punctuation z-section z-scope z-crystal">{</span><span class="z-constant z-language z-crystal">nil</span><span class="z-punctuation z-separator z-object z-crystal">,</span> current_active_time <span class="z-keyword z-operator z-arithmetic z-crystal">+</span> active_time<span class="z-punctuation z-section z-scope z-crystal">}</span>
</span><span class="z-source z-crystal">    <span class="z-keyword z-control z-secondary z-end z-crystal">end</span>
</span><span class="z-source z-crystal">  <span class="z-keyword z-control z-secondary z-end z-crystal">end</span>
</span><span class="z-source z-crystal"><span class="z-keyword z-control z-secondary z-end z-crystal">end</span>
</span><span class="z-source z-crystal">
</span><span class="z-source z-crystal">total_active_time <span class="z-keyword z-operator z-assignment z-crystal">=</span> fiber_data<span class="z-punctuation z-separator z-method z-crystal">.</span>values<span class="z-punctuation z-separator z-method z-crystal">.</span>sum <span class="z-punctuation z-section z-scope z-crystal">{</span><span class="z-meta z-syntax z-crystal z-start-block"> </span><span class="z-punctuation z-separator z-variable z-crystal">|</span><span class="z-variable z-other z-block z-crystal">data</span><span class="z-punctuation z-separator z-variable z-crystal">|</span> data<span class="z-punctuation z-section z-array z-crystal">[</span><span class="z-constant z-numeric z-crystal">1</span><span class="z-punctuation z-section z-array z-crystal">]</span> <span class="z-punctuation z-section z-scope z-crystal">}</span>
</span><span class="z-source z-crystal">
</span><span class="z-source z-crystal">printf <span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>%-25s %15s %10s<span class="z-constant z-character z-escape z-crystal">\n</span><span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span><span class="z-punctuation z-separator z-object z-crystal">,</span> <span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>Fiber Name<span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span><span class="z-punctuation z-separator z-object z-crystal">,</span> <span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>Active Time (ms)<span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span><span class="z-punctuation z-separator z-object z-crystal">,</span> <span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>Percent<span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span>
</span><span class="z-source z-crystal">puts <span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>-<span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span> <span class="z-keyword z-operator z-arithmetic z-crystal">*</span> <span class="z-constant z-numeric z-crystal">52</span>
</span><span class="z-source z-crystal">
</span><span class="z-source z-crystal"><span class="z-comment z-line z-number-sign z-crystal"><span class="z-punctuation z-definition z-comment z-crystal">#</span> Sort fibers by total active time (descending) and print minimal output
</span></span><span class="z-source z-crystal">fiber_data<span class="z-punctuation z-separator z-method z-crystal">.</span>to_a<span class="z-punctuation z-separator z-method z-crystal">.</span>sort_by <span class="z-punctuation z-section z-scope z-crystal">{</span><span class="z-meta z-syntax z-crystal z-start-block"> </span><span class="z-punctuation z-separator z-variable z-crystal">|</span><span class="z-variable z-other z-block z-crystal">_</span><span class="z-punctuation z-separator z-variable z-crystal">,</span> <span class="z-variable z-other z-block z-crystal">data</span><span class="z-punctuation z-separator z-variable z-crystal">|</span> <span class="z-keyword z-operator z-arithmetic z-crystal">-</span>data<span class="z-punctuation z-section z-array z-crystal">[</span><span class="z-constant z-numeric z-crystal">1</span><span class="z-punctuation z-section z-array z-crystal">]</span> <span class="z-punctuation z-section z-scope z-crystal">}</span><span class="z-punctuation z-separator z-method z-crystal">.</span>each <span class="z-keyword z-control z-start-block z-crystal">do </span><span class="z-punctuation z-separator z-variable z-crystal">|</span><span class="z-variable z-other z-block z-crystal">fiber_name</span><span class="z-punctuation z-separator z-variable z-crystal">,</span> <span class="z-variable z-other z-block z-crystal">data</span><span class="z-punctuation z-separator z-variable z-crystal">|</span>
</span><span class="z-source z-crystal">  active_time <span class="z-keyword z-operator z-assignment z-crystal">=</span> data<span class="z-punctuation z-section z-array z-crystal">[</span><span class="z-constant z-numeric z-crystal">1</span><span class="z-punctuation z-section z-array z-crystal">]</span>
</span><span class="z-source z-crystal">  active_ms <span class="z-keyword z-operator z-assignment z-crystal">=</span> active_time <span class="z-keyword z-operator z-arithmetic z-crystal">/</span> <span class="z-constant z-numeric z-crystal">1_000_000.0</span>
</span><span class="z-source z-crystal">  active_percentage <span class="z-keyword z-operator z-assignment z-crystal">=</span> total_active_time <span class="z-keyword z-operator z-comparison z-crystal">&gt;</span> <span class="z-constant z-numeric z-crystal">0</span> <span class="z-keyword z-operator z-comparison z-crystal">?</span> active_time<span class="z-punctuation z-separator z-method z-crystal">.</span>to_f <span class="z-keyword z-operator z-arithmetic z-crystal">/</span> total_active_time <span class="z-keyword z-operator z-arithmetic z-crystal">*</span> <span class="z-constant z-numeric z-crystal">100</span> <span class="z-punctuation z-separator z-other z-crystal">:</span> <span class="z-constant z-numeric z-crystal">0.0</span>
</span><span class="z-source z-crystal">  printf <span class="z-string z-quoted z-double z-crystal"><span class="z-punctuation z-definition z-string z-begin z-crystal">&quot;</span>%-25s %15.2f %9.2f%%<span class="z-constant z-character z-escape z-crystal">\n</span><span class="z-punctuation z-definition z-string z-end z-crystal">&quot;</span></span><span class="z-punctuation z-separator z-object z-crystal">,</span> fiber_name<span class="z-punctuation z-separator z-object z-crystal">,</span> active_ms<span class="z-punctuation z-separator z-object z-crystal">,</span> active_percentage
</span><span class="z-source z-crystal"><span class="z-keyword z-control z-secondary z-end z-crystal">end</span>
</span></code></pre>
<p>As output, we can see the distribution of CPU time between fibers.
For this method to work well, it is good practice to give a name to fibers when you spawn them as in the example above.</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[dynamic_tracing]</span></span><span class="z-meta z-function-call z-arguments z-shell"> Scheduler tracing ENABLED</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[dynamic_tracing]</span></span><span class="z-meta z-function-call z-arguments z-shell"> Scheduler tracing DISABLED</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Fiber</span></span><span class="z-meta z-function-call z-arguments z-shell"> Name                Active Time (ms</span><span class="z-meta z-function-call z-shell"></span>)    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Percent</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">----------------------------------------------------</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Fiber_cpu_blocker2</span></span><span class="z-meta z-function-call z-arguments z-shell">                 658.32     65.22<span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Fiber_cpu_blocker1</span></span><span class="z-meta z-function-call z-arguments z-shell">                 347.27     34.40<span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Fiber_IO</span></span><span class="z-meta z-function-call z-arguments z-shell">                             1.91      0.19<span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Fiber_sleeper</span></span><span class="z-meta z-function-call z-arguments z-shell">                        1.87      0.19<span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">signal-loop</span></span><span class="z-meta z-function-call z-arguments z-shell">                          0.06      0.01<span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0x714a10450a50</span></span><span class="z-meta z-function-call z-arguments z-shell">                       0.00      0.00<span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0x714a104509a0</span></span><span class="z-meta z-function-call z-arguments z-shell">                       0.00      0.00<span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span></span></span>
</span></code></pre>
<p>As expected, <code>Fiber_cpu_blocker2</code> takes most of the CPU time, while <code>Fiber_cpu_blocker1</code> takes half as much.
The next one - <code>Fiber_IO</code> - takes a small amount of CPU time.
Others - <code>Fiber_sleeper</code> and system fibers - take even less.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Of course, this is not a very advanced and comprehensive performance analysis method.
But it can give you a basic understanding of what is going on in your application.
For deeper performance analysis in Crystal - there are traditional ways of performance analysis like <code>perf</code> that work perfectly for Crystal as well.</p>

      <nav>
        <div>
        </div>
        <div>
          <a href="https://alexkutsan.github.io/posts/dvwa-brutforce/"> Brutforce http on dvwa example &#8250;</a>
        </div>
      </nav>
    </article>

    <div class="sblock">
      <div class="blockdiv sticky">
        <a class="b s150" href="#">Index</a>
        <div>
          <a href="#liryc-intro">Liryc intro</a>
        </div>
        <div class="hpad">
          <a href="#concurrency-in-crystal"><small>- Concurrency in Crystal</small></a>
        </div>
        <div class="hpad">
          <a href="#the-problem-identifying-misbehaving-fibers"><small>- The Problem: Identifying Misbehaving Fibers</small></a>
        </div>
        <div class="hpad">
          <a href="#dynamic-tracing-solution"><small>- Dynamic Tracing Solution</small></a>
        </div>
        <div class="hpad">
          <a href="#using-dynamic-tracing-in-practice"><small>- Using Dynamic Tracing in Practice</small></a>
        </div>
        <div class="hpad">
          <a href="#analyzing-trace-results"><small>- Analyzing Trace Results</small></a>
        </div>
        <div class="hpad">
          <a href="#conclusion"><small>- Conclusion</small></a>
        </div>
      </div>
    </div>
  </main>
  <footer>
    <hr />
    <div class="c">
      <nav class="tpad"><div><a type="application/atom+xml" href="https://alexkutsan.github.io/atom.xml" target="_blank" title="Alexander Kutsan Atom Feed"><i type="Button" class="svg rss" title="Alexander Kutsan Atom Feed"></i></a><a class="js m-protected" href="#YWxleGt1dHNhbkBnbWFpbC5jb20=" target="_blank" title="Mail"><i type="Button" class="svg mail" title="Mail"></i></a><a href="https://github.com/alexkutsan/" target="_blank" title="Github"><i type="Button" class="svg github" title="Github"></i></a><a href="https://t.me/alex_kutsan/" target="_blank" title="Telegram"><i type="Button" class="svg telegram" title="Telegram"></i></a></div></nav>
      <nav class="vpad">
        <a class="rpad s90" href="https://alexkutsan.github.io/"> Home </a>
        <a class="rpad s90" href="https://alexkutsan.github.io/sitemap.xml" target="_blank"> Sitemap </a>
      </nav>
      <p class="s80"> &copy; <span id="year">2025</span> Alexander Kutsan</p>
      <p class="s80">Powered by <a href="https://www.getzola.org/" target="_blank">Zola</a> & <a href="https://github.com/jieiku/abridge/" target="_blank">Abridge</a></p>
    </div>
  </footer><span class="topout">
<span class="topleft"> </span><a href="#" class="top" title="Back to Top"><i class="svgs svgh angu"></i></a>
</span>
</body>
</html>
